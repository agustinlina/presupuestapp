<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Presupuestador Unión S.A</title>
  <link rel="stylesheet" href="estilos.css">
  <style>
    input, textarea, select {
      min-width: 180px;
      max-width: 220px;
      width: 200px;
      box-sizing: border-box;
      padding: 5px 8px;
      font-size: 1rem;
    }
    textarea {
      width: 100%;
      min-width: 200px;
      max-width: 99%;
    }
    label {
      margin-top: 12px;
      margin-bottom: 2px;
      display: block;
    }
    .table-container table input {
      min-width: 60px;
      max-width: 100px;
      width: 90px;
      text-align: left;
    }
    .table-container table td {
      padding: 4px 2px;
    }
    .leyenda {
      font-size: 1.15rem;
      font-weight: bold;
      margin: 32px 0 40px 0;
      text-align: left;
      letter-spacing: 0.5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Presupuesto Unión S.A</h1>
    <form id="formPresupuesto" autocomplete="off">
      <label>Nombre de la empresa cliente:</label>
      <input name="nombreCliente" required value="Empresa Ejemplo S.A." placeholder="Nombre de la empresa">

      <label>CUIT cliente:</label>
      <input name="cuitCliente" required pattern="[0-9\-]{11,13}" value="99-99999999-9" placeholder="99-99999999-9">

      <label>Validez del presupuesto (fecha):</label>
      <input name="fechaValidez" type="date">

      <div style="display: flex; align-items: center; gap:10px; margin: 10px 0;">
        <label for="ivaIncluido" style="margin: 0;">¿IVA incluido?</label>
        <input id="ivaIncluido" type="checkbox" name="ivaIncluido" checked>
      </div>

      <label>Condiciones de venta:</label>
      <input name="condiciones" required value="Contado" placeholder="Contado, 30 días, etc.">

      <div class="leyenda">Presupuesto por Ud. requerido</div>

      <div class="table-container">
        <table id="tablaProductos">
          <thead>
            <tr>
              <th style="text-align:left;">Cantidad</th>
              <th style="text-align:left;">Descripción</th>
              <th style="text-align:left;">Precio unitario</th>
              <th style="text-align:left;">Total</th>
              <th>Quitar</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button type="button" class="btn" id="agregarFila">Agregar producto</button>
      </div>

      <div class="totales">Total: $<span id="totalGeneral">0,00</span></div>

      <label>Observaciones:</label>
      <textarea name="observaciones" rows="2" placeholder="Aclaraciones, entregas, condiciones especiales, etc."></textarea>

      <button class="btn" type="submit" style="margin-top:22px; float:right;">Descargar PDF</button>
    </form>
  </div>
  <script>
    const tbody = document.querySelector('#tablaProductos tbody');
    const agregarFilaBtn = document.getElementById('agregarFila');
    const totalGeneral = document.getElementById('totalGeneral');

    function crearFila(datos={}) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="number" name="cantidad" min="1" value="${datos.cantidad !== undefined ? datos.cantidad : 1}" required></td>
        <td><input type="text" name="descripcion" value="${datos.descripcion !== undefined ? datos.descripcion : 'Producto genérico'}" required></td>
        <td><input type="number" name="precio" min="0" step="0.01" value="${datos.precio !== undefined ? datos.precio : 100}" required></td>
        <td class="total-fila">$0,00</td>
        <td><button type="button" class="del-btn" title="Quitar fila">&times;</button></td>
      `;
      tbody.appendChild(tr);
      tr.querySelector('.del-btn').onclick = () => {
        tr.remove();
        calcularTotales();
      };
      tr.querySelectorAll('input').forEach(inp =>
        inp.oninput = calcularTotales
      );
      return tr;
    }

    // Dos filas por defecto con valores ejemplo
    crearFila();
    crearFila();

    agregarFilaBtn.onclick = () => crearFila();

    // Formato argentino para miles y decimales
    function formatMonto(n) {
      return n.toFixed(2)
        .replace('.', ',')
        .replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    function calcularTotales() {
      let total = 0;
      tbody.querySelectorAll('tr').forEach(tr => {
        const cantidad = parseFloat(tr.querySelector('[name="cantidad"]').value) || 0;
        const precio = parseFloat(tr.querySelector('[name="precio"]').value) || 0;
        const subtotal = cantidad * precio;
        tr.querySelector('.total-fila').textContent = subtotal ? `$${formatMonto(subtotal)}` : '$0,00';
        total += subtotal;
      });
      totalGeneral.textContent = formatMonto(total);
    }
    tbody.addEventListener('input', calcularTotales);

    document.getElementById('formPresupuesto').onsubmit = async e => {
      e.preventDefault();
      const form = e.target;
      const productos = [];
      tbody.querySelectorAll('tr').forEach(tr => {
        const cantidad = tr.querySelector('[name="cantidad"]').value;
        const descripcion = tr.querySelector('[name="descripcion"]').value;
        const precio = tr.querySelector('[name="precio"]').value;
        if (cantidad && descripcion && precio) {
          productos.push({
            cantidad: parseInt(cantidad),
            descripcion,
            precio: parseFloat(precio)
          });
        }
      });
      if (productos.length < 1) {
        alert('Agregue al menos un producto');
        return;
      }
      const datos = {
        nombreCliente: form.nombreCliente.value,
        cuitCliente: form.cuitCliente.value,
        condiciones: form.condiciones.value,
        observaciones: form.observaciones.value,
        ivaIncluido: form.ivaIncluido.checked,
        fechaValidez: form.fechaValidez.value,
        productos
      };
      const res = await fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datos)
      });
      if (res.ok) {
        const blob = await res.blob();
        // Extraer nombre del archivo de Content-Disposition si lo deseas:
        const disposition = res.headers.get('Content-Disposition');
        let fileName = "presupuesto.pdf";
        if (disposition && disposition.includes("filename=")) {
          fileName = disposition.split("filename=")[1].replace(/["']/g, "");
        }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(url);
      } else {
        alert('Error generando el PDF');
      }
    };
    calcularTotales();
  </script>
</body>
</html>
